# 架构设计文档

## 设计概述

Cocos Inspector 采用模块化的架构设计，将功能划分为多个独立且高内聚的模块，通过明确的接口进行交互。这种设计使得系统具有良好的可扩展性、可维护性和可测试性。本文档描述了 Cocos Inspector 的整体架构设计、核心模块及其交互关系。

## 系统架构

### 整体架构

Cocos Inspector 采用分层架构，从下至上分为以下几层：

1. **注入层**: 负责将检查器脚本注入到目标页面中
2. **核心层**: 包含检查器的核心功能实现
3. **渲染层**: 负责处理 UI 渲染和用户交互
4. **扩展层**: 提供 API 允许功能扩展

### 架构图

```
┌───────────────────────────────────────────────────────────────┐
│                       Cocos Inspector                         │
├───────────────────────────────────────────────────────────────┤
│ ┌─────────────────────┐        ┌──────────────────────────┐  │
│ │     扩展层          │        │      渲染层             │  │
│ │  Extension Layer    │        │    Rendering Layer      │  │
│ │                     │        │                         │  │
│ │ ┌─────────────────┐ │        │ ┌─────────────────────┐ │  │
│ │ │ 钩子系统扩展    │ │        │ │ 组件渲染器         │ │  │
│ │ └─────────────────┘ │        │ └─────────────────────┘ │  │
│ │ ┌─────────────────┐ │        │ ┌─────────────────────┐ │  │
│ │ │ 自定义渲染器    │ │        │ │ UI控制器           │ │  │
│ │ └─────────────────┘ │        │ └─────────────────────┘ │  │
│ └─────────────────────┘        └──────────────────────────┘  │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐  │
│ │                      核心层                             │  │
│ │                   Core Layer                            │  │
│ │                                                         │  │
│ │ ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐ │  │
│ │ │  节点树管理 │  │ 属性检查器  │  │ 钩子管理器      │ │  │
│ │ └─────────────┘  └─────────────┘  └──────────────────┘ │  │
│ │ ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐ │  │
│ │ │ 更新引擎    │  │ 性能优化    │  │ 属性修改器      │ │  │
│ │ └─────────────┘  └─────────────┘  └──────────────────┘ │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐  │
│ │                      注入层                             │  │
│ │                  Injection Layer                        │  │
│ │                                                         │  │
│ │ ┌─────────────────┐         ┌─────────────────────────┐ │  │
│ │ │  内容脚本      │         │  注入脚本               │ │  │
│ │ │ Content Script  │         │  Injected Script        │ │  │
│ │ └─────────────────┘         └─────────────────────────┘ │  │
│ └─────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────┘
```

## 核心模块

### 注入层

注入层负责将检查器脚本注入到目标页面中，包含以下组件：

1. **内容脚本 (Content Script)**

   - 作为 Chrome 扩展的内容脚本，在目标页面中运行
   - 负责检测页面是否包含 Cocos 引擎
   - 将主脚本注入到页面中

2. **注入脚本 (Injected Script)**
   - 被注入到目标页面中的主脚本
   - 能够直接访问页面的 JavaScript 环境和 Cocos 对象
   - 包含检查器的主要功能实现

### 核心层

核心层包含检查器的主要功能实现，是系统的核心部分：

1. **节点树管理模块**

   - 负责遍历 Cocos 场景节点树
   - 管理节点的展开/折叠状态
   - 实现节点的查询和过滤功能

2. **属性检查器模块**

   - 提供节点属性的查看和编辑功能
   - 管理属性的实时更新
   - 处理不同类型属性的显示和编辑逻辑

3. **钩子管理器**

   - 管理属性读取/写入钩子
   - 实现属性访问拦截和监控
   - 提供钩子状态管理和事件通知

4. **更新引擎**

   - 控制检查器的更新频率和方式
   - 实现自动/手动更新模式切换
   - 提供增量更新和全量更新策略

5. **性能优化模块**

   - 实现 DOM 操作批处理
   - 控制更新节流和延迟加载
   - 提供性能监控和优化建议

6. **属性修改器**
   - 处理属性修改的逻辑
   - 确保修改能够正确应用到游戏对象
   - 提供撤销/重做支持(计划中)

### 渲染层

渲染层负责用户界面的呈现和交互，包含以下组件：

1. **组件渲染器系统**

   - 提供可扩展的组件渲染机制
   - 内置常用组件的渲染器
   - 支持自定义组件渲染器注册

2. **UI 控制器**
   - 处理检查器面板的创建和管理
   - 实现界面交互事件处理
   - 提供界面状态管理和持久化

### 扩展层

扩展层提供 API 允许功能扩展，包含：

1. **钩子系统扩展**

   - 允许自定义钩子逻辑
   - 提供钩子过滤和条件触发

2. **自定义渲染器**
   - 支持注册自定义组件渲染器
   - 允许扩展属性编辑器

## 模块交互

### 数据流

Cocos Inspector 中的数据流主要遵循以下模式：

1. **节点树数据流**:

   ```
   Cocos场景 → 节点树管理模块 → 节点树渲染 → 用户界面
   ```

2. **属性数据流**:

   ```
   节点选择 → 属性检查器模块 → 组件渲染器 → 属性编辑UI → 用户修改 → 属性修改器 → Cocos节点
   ```

3. **钩子数据流**:
   ```
   属性钩子设置 → 钩子管理器 → 属性钩子 → 属性访问/修改拦截 → 日志输出
   ```

### 事件系统

模块间通过事件系统进行松耦合的交互，主要事件包括：

1. **节点事件**:

   - `node-selected`: 节点被选中
   - `node-expanded`: 节点被展开
   - `node-collapsed`: 节点被折叠

2. **属性事件**:

   - `property-changed`: 属性值变更
   - `property-hooked`: 属性钩子设置
   - `property-unhooked`: 属性钩子移除

3. **系统事件**:
   - `update-started`: 更新开始
   - `update-completed`: 更新完成
   - `error-occurred`: 发生错误

## 代码组织

### 目录结构

```
src/
├── content.ts                # 内容脚本
├── injected.ts               # 注入脚本 (主入口)
├── styles/                   # 样式文件
│   └── inspector.css         # 检查器样式
├── renderers/                # 渲染器
│   ├── RendererManager.ts    # 渲染器管理器
│   ├── DefaultRenderer.ts    # 默认渲染器
│   └── TransformRenderer.ts  # 变换组件渲染器
├── hooks/                    # 钩子系统
│   ├── HookManager.ts        # 钩子管理器
│   ├── PropertyHook.ts       # 属性钩子
│   ├── HookUIRenderer.ts     # 钩子UI渲染器
│   └── HookConfig.ts         # 钩子配置
└── types/                    # 类型定义
    ├── cocos.d.ts            # Cocos引擎类型
    ├── components.ts         # 组件类型
    └── chrome.d.ts           # Chrome API类型
```

### 命名规范

- **文件命名**: 使用 PascalCase(大驼峰)命名法，如`RendererManager.ts`
- **类命名**: 使用 PascalCase(大驼峰)命名法，如`class PropertyHook`
- **接口命名**: 使用 PascalCase(大驼峰)命名法，通常以"I"开头，如`interface IComponentRenderer`
- **方法命名**: 使用 camelCase(小驼峰)命名法，如`addHook()`
- **私有成员**: 使用下划线前缀，如`private _selectedNode`

## 设计模式应用

Cocos Inspector 实现中应用了多种设计模式，主要包括：

1. **单例模式**:

   - 应用于`HookManager`类，确保系统中只有一个钩子管理器实例

2. **策略模式**:

   - 应用于组件渲染器系统，允许在运行时选择不同的组件渲染策略

3. **观察者模式**:

   - 通过事件系统实现，允许模块间的松耦合通信

4. **装饰器模式**:

   - 应用于属性钩子实现，通过 JavaScript 的属性描述符扩展属性行为

5. **工厂模式**:
   - 应用于渲染器创建，通过`RendererManager`创建适合的渲染器

## 可扩展性设计

Cocos Inspector 设计了多个扩展点，允许功能扩展：

1. **组件渲染器扩展**:

   - 实现`ComponentRenderer`接口
   - 通过`RendererManager.registerRenderer()`方法注册

2. **钩子配置扩展**:

   - 通过扩展`PROPERTY_HOOK_MAPPINGS`对象添加新的钩子配置

3. **主题样式扩展**:
   - 通过 CSS 变量和主题类支持自定义主题

## 性能考虑

架构设计中考虑了以下性能因素：

1. **增量更新**:

   - 只更新发生变化的部分，减少 DOM 操作

2. **延迟加载**:

   - 非关键功能延迟加载

3. **事件委托**:

   - 使用事件委托减少事件监听器数量

4. **虚拟化**:
   - 计划实现节点树的虚拟滚动，只渲染可见区域

## 未来架构演进

1. **插件系统**:

   - 实现完整的插件系统，支持第三方功能扩展

2. **远程调试**:

   - 支持通过网络连接远程调试 Cocos 游戏

3. **持久化层**:

   - 增强本地存储，支持更复杂的配置和状态持久化

4. **工具链集成**:
   - 与其他开发工具集成，提供更完整的开发体验
