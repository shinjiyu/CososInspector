<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>FastSpin JS ä»£ç åˆ†æå™¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Monaco", "Consolas", "Courier New", monospace;
        background: #0d1117;
        color: #c9d1d9;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #238636 0%, #1f6feb 100%);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .header h1 {
        font-size: 18px;
        color: #fff;
      }

      .tabs {
        display: flex;
        gap: 5px;
      }

      .tab {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        font-size: 13px;
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.25);
      }

      .main {
        display: flex;
        height: calc(100vh - 60px);
      }

      .sidebar {
        width: 300px;
        background: #161b22;
        border-right: 1px solid #30363d;
        overflow-y: auto;
      }

      .sidebar-section {
        border-bottom: 1px solid #30363d;
      }

      .sidebar-section h3 {
        padding: 12px 15px;
        font-size: 12px;
        color: #8b949e;
        background: #0d1117;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
      }

      .sidebar-section h3:hover {
        background: #161b22;
      }

      .sidebar-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .sidebar-item {
        padding: 8px 15px;
        font-size: 12px;
        cursor: pointer;
        border-left: 3px solid transparent;
      }

      .sidebar-item:hover {
        background: #21262d;
      }
      .sidebar-item.active {
        background: #1f6feb20;
        border-left-color: #1f6feb;
        color: #58a6ff;
      }

      .sidebar-item .type {
        display: inline-block;
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 10px;
        margin-right: 5px;
      }

      .type-class {
        background: #238636;
        color: #fff;
      }
      .type-function {
        background: #1f6feb;
        color: #fff;
      }
      .type-var {
        background: #f0883e;
        color: #fff;
      }
      .type-module {
        background: #a371f7;
        color: #fff;
      }

      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .toolbar {
        padding: 10px 15px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .toolbar input {
        flex: 1;
        padding: 8px 12px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-size: 13px;
      }

      .toolbar button {
        padding: 8px 16px;
        background: #238636;
        border: none;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        font-size: 13px;
      }

      .toolbar button:hover {
        background: #2ea043;
      }

      .code-view {
        flex: 1;
        overflow: auto;
        padding: 15px;
      }

      .code-view pre {
        font-size: 13px;
        line-height: 1.5;
        tab-size: 2;
      }

      .drop-overlay {
        position: fixed;
        inset: 0;
        background: rgba(31, 111, 235, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #fff;
        z-index: 100;
      }

      .drop-overlay.active {
        display: flex;
      }

      /* è¯­æ³•é«˜äº® */
      .keyword {
        color: #ff7b72;
      }
      .string {
        color: #a5d6ff;
      }
      .number {
        color: #79c0ff;
      }
      .comment {
        color: #8b949e;
      }
      .function {
        color: #d2a8ff;
      }
      .class {
        color: #7ee787;
      }
      .property {
        color: #79c0ff;
      }

      .analysis-panel {
        background: #161b22;
        border-top: 1px solid #30363d;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .analysis-panel h3 {
        color: #58a6ff;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .analysis-item {
        background: #0d1117;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 12px;
      }

      .analysis-item h4 {
        color: #7ee787;
        margin-bottom: 5px;
      }
      .analysis-item code {
        display: block;
        background: #161b22;
        padding: 8px;
        margin-top: 5px;
        border-radius: 4px;
        overflow-x: auto;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #8b949e;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ” FastSpin JS ä»£ç åˆ†æå™¨</h1>
      <div class="tabs">
        <button class="tab active" data-tab="files">æ–‡ä»¶åˆ—è¡¨</button>
        <button class="tab" data-tab="classes">ç±»å®šä¹‰</button>
        <button class="tab" data-tab="flow">åŠ è½½æµç¨‹</button>
        <button class="tab" data-tab="components">ç»„ä»¶ç³»ç»Ÿ</button>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <div class="sidebar-section">
          <h3>ğŸ“ JS æ–‡ä»¶ <span id="fileCount">0</span></h3>
          <div class="sidebar-list" id="fileList">
            <div class="loading">æ‹–æ”¾ HAR æ–‡ä»¶æˆ– JS æ–‡ä»¶åˆ°é¡µé¢</div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>ğŸ“¦ ç±»å®šä¹‰ <span id="classCount">0</span></h3>
          <div class="sidebar-list" id="classList"></div>
        </div>

        <div class="sidebar-section">
          <h3>âš¡ å‡½æ•° <span id="funcCount">0</span></h3>
          <div class="sidebar-list" id="funcList"></div>
        </div>

        <div class="sidebar-section">
          <h3>ğŸ”§ é‡è¦æ¨¡å¼ <span id="patternCount">0</span></h3>
          <div class="sidebar-list" id="patternList"></div>
        </div>
      </div>

      <div class="content">
        <div class="toolbar">
          <input
            type="text"
            id="searchInput"
            placeholder="æœç´¢ä»£ç ... (æ”¯æŒæ­£åˆ™)"
          />
          <button onclick="searchCode()">æœç´¢</button>
          <button onclick="beautifyCode()">ç¾åŒ–ä»£ç </button>
          <button onclick="exportAnalysis()">å¯¼å‡ºåˆ†æ</button>
        </div>

        <div class="code-view" id="codeView">
          <pre id="codeContent">
// æ‹–æ”¾æ–‡ä»¶å¼€å§‹åˆ†æ
// 
// æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š
// - HAR æ–‡ä»¶ (åŒ…å« JS å†…å®¹)
// - JS æ–‡ä»¶ (ç›´æ¥æ‹–æ”¾)
// 
// åˆ†æå†…å®¹ï¼š
// 1. ç±»å®šä¹‰å’Œç»§æ‰¿å…³ç³»
// 2. å‡½æ•°å£°æ˜å’Œè°ƒç”¨å…³ç³»
// 3. ç»„ä»¶ç³»ç»Ÿæ¨¡å¼
// 4. äº‹ä»¶ç³»ç»Ÿ
// 5. èµ„æºåŠ è½½æµç¨‹
                </pre
          >
        </div>

        <div class="analysis-panel" id="analysisPanel" style="display: none">
          <h3>ğŸ“Š ä»£ç åˆ†æç»“æœ</h3>
          <div id="analysisContent"></div>
        </div>
      </div>
    </div>

    <div class="drop-overlay" id="dropOverlay">ğŸ“‚ æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ</div>

    <script>
      // çŠ¶æ€ç®¡ç†
      let files = [];
      let classes = [];
      let functions = [];
      let patterns = [];
      let currentFile = null;

      // FastSpin ç‰¹æœ‰æ¨¡å¼
      const FASTSPIN_PATTERNS = {
        "Component Registration":
          /(?:registerComponent|addComponent|createComponent)\s*\(\s*['"]([\w]+)['"]/g,
        "Event Binding":
          /(?:on|addEventListener|bind)\s*\(\s*['"]([\w:]+)['"]/g,
        "Asset Loading":
          /(?:loadAsset|loadRes|loadBundle)\s*\(\s*['"]([\w\/\.]+)['"]/g,
        "Scene Management":
          /(?:loadScene|changeScene|pushScene)\s*\(\s*['"]([\w]+)['"]/g,
        "Spine Creation": /(?:sp\.Skeleton|spine\.Skeleton|new\s+Spine)/g,
        "Sprite Creation": /(?:cc\.Sprite|new\s+Sprite|createSprite)/g,
        "Node Creation": /(?:new\s+cc\.Node|createNode|addChild)\s*\(/g,
        Animation:
          /(?:animation\.play|playAnimation|runAction)\s*\(\s*['"]([\w]+)['"]/g,
        "State Machine": /(?:setState|changeState|FSM|StateMachine)/g,
        "Pool System": /(?:NodePool|ObjectPool|getFromPool|returnToPool)/g,
        "Signal/Event":
          /(?:emit|dispatch|trigger|signal)\s*\(\s*['"]([\w:]+)['"]/g,
        Configuration:
          /(?:config|Config|settings|Settings|options|Options)\s*[=:]/g,
        "Module Export":
          /(?:module\.exports|export\s+(?:default|class|function|const))/g,
        "Module Import": /(?:require\s*\(|import\s+.*\s+from)/g,
      };

      // æ‹–æ”¾å¤„ç†
      document.addEventListener("dragover", (e) => {
        e.preventDefault();
        document.getElementById("dropOverlay").classList.add("active");
      });

      document.addEventListener("dragleave", (e) => {
        if (e.target === document.getElementById("dropOverlay")) {
          document.getElementById("dropOverlay").classList.remove("active");
        }
      });

      document.addEventListener("drop", (e) => {
        e.preventDefault();
        document.getElementById("dropOverlay").classList.remove("active");

        const droppedFiles = Array.from(e.dataTransfer.files);
        processFiles(droppedFiles);
      });

      async function processFiles(droppedFiles) {
        for (const file of droppedFiles) {
          const text = await file.text();

          if (file.name.endsWith(".har")) {
            // è§£æ HAR æ–‡ä»¶
            try {
              const har = JSON.parse(text);
              extractJSFromHAR(har);
            } catch (e) {
              alert("HAR è§£æå¤±è´¥: " + e.message);
            }
          } else if (file.name.endsWith(".js")) {
            // ç›´æ¥æ·»åŠ  JS æ–‡ä»¶
            files.push({
              name: file.name,
              content: text,
              size: text.length,
            });
          }
        }

        analyzeAllFiles();
        renderUI();
      }

      function extractJSFromHAR(har) {
        const entries = har.log?.entries || [];

        for (const entry of entries) {
          const url = entry.request?.url || "";
          const content = entry.response?.content?.text;
          const mimeType = entry.response?.content?.mimeType || "";

          if (
            (url.endsWith(".js") || mimeType.includes("javascript")) &&
            content
          ) {
            const filename = url.split("/").pop().split("?")[0];

            // é¿å…é‡å¤
            if (!files.find((f) => f.name === filename)) {
              files.push({
                name: filename,
                url: url,
                content: content,
                size: content.length,
              });
            }
          }
        }
      }

      function analyzeAllFiles() {
        classes = [];
        functions = [];
        patterns = [];

        for (const file of files) {
          analyzeFile(file);
        }

        // æ’åº
        files.sort((a, b) => {
          // æŒ‰åŠ è½½é¡ºåºæ’åº (lib -> slot -> game -> setup)
          const order = ["lib_mm", "slot", "game", "polyfill", "setup"];
          const aIdx = order.findIndex((o) => a.name.includes(o));
          const bIdx = order.findIndex((o) => b.name.includes(o));
          return (aIdx === -1 ? 99 : aIdx) - (bIdx === -1 ? 99 : bIdx);
        });
      }

      function analyzeFile(file) {
        const code = file.content;

        // æå–ç±»å®šä¹‰
        const classRegex =
          /(?:class\s+(\w+)(?:\s+extends\s+(\w+))?|(\w+)\s*=\s*(?:function|class)|\b(\w+)\.prototype\b)/g;
        let match;
        while ((match = classRegex.exec(code)) !== null) {
          const name = match[1] || match[3] || match[4];
          if (
            name &&
            name.length > 2 &&
            !classes.find((c) => c.name === name)
          ) {
            classes.push({
              name: name,
              extends: match[2] || null,
              file: file.name,
              position: match.index,
            });
          }
        }

        // æå–å‡½æ•°å®šä¹‰
        const funcRegex =
          /(?:function\s+(\w+)|(\w+)\s*[=:]\s*(?:async\s+)?function|\b(\w+)\s*\([^)]*\)\s*\{)/g;
        while ((match = funcRegex.exec(code)) !== null) {
          const name = match[1] || match[2] || match[3];
          if (
            name &&
            name.length > 2 &&
            !["if", "for", "while", "switch", "catch"].includes(name)
          ) {
            if (
              !functions.find((f) => f.name === name && f.file === file.name)
            ) {
              functions.push({
                name: name,
                file: file.name,
                position: match.index,
              });
            }
          }
        }

        // æ£€æµ‹é‡è¦æ¨¡å¼
        for (const [patternName, regex] of Object.entries(FASTSPIN_PATTERNS)) {
          const patternRegex = new RegExp(regex.source, regex.flags);
          while ((match = patternRegex.exec(code)) !== null) {
            patterns.push({
              type: patternName,
              match: match[0],
              value: match[1] || match[0],
              file: file.name,
              position: match.index,
            });
          }
        }
      }

      function renderUI() {
        // æ›´æ–°è®¡æ•°
        document.getElementById("fileCount").textContent = files.length;
        document.getElementById("classCount").textContent = classes.length;
        document.getElementById("funcCount").textContent = functions.length;
        document.getElementById("patternCount").textContent = patterns.length;

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        document.getElementById("fileList").innerHTML =
          files
            .map(
              (f) => `
                <div class="sidebar-item" onclick="selectFile('${f.name}')">
                    <span class="type type-module">JS</span>
                    ${f.name}
                    <span style="float:right;color:#8b949e;">${(
                      f.size / 1024
                    ).toFixed(1)}KB</span>
                </div>
            `
            )
            .join("") || '<div class="loading">æ— æ–‡ä»¶</div>';

        // æ¸²æŸ“ç±»åˆ—è¡¨
        document.getElementById("classList").innerHTML =
          classes
            .slice(0, 50)
            .map(
              (c) => `
                <div class="sidebar-item" onclick="goToDefinition('${
                  c.file
                }', ${c.position})">
                    <span class="type type-class">C</span>
                    ${c.name}
                    ${
                      c.extends
                        ? `<span style="color:#8b949e;"> : ${c.extends}</span>`
                        : ""
                    }
                </div>
            `
            )
            .join("") || '<div class="loading">æ— ç±»å®šä¹‰</div>';

        // æ¸²æŸ“å‡½æ•°åˆ—è¡¨
        document.getElementById("funcList").innerHTML =
          functions
            .slice(0, 50)
            .map(
              (f) => `
                <div class="sidebar-item" onclick="goToDefinition('${f.file}', ${f.position})">
                    <span class="type type-function">F</span>
                    ${f.name}
                </div>
            `
            )
            .join("") || '<div class="loading">æ— å‡½æ•°</div>';

        // æ¸²æŸ“æ¨¡å¼åˆ—è¡¨
        const patternGroups = {};
        patterns.forEach((p) => {
          if (!patternGroups[p.type]) patternGroups[p.type] = [];
          patternGroups[p.type].push(p);
        });

        document.getElementById("patternList").innerHTML =
          Object.entries(patternGroups)
            .map(
              ([type, items]) => `
                <div class="sidebar-item" onclick="showPatternDetails('${type}')">
                    <span class="type type-var">P</span>
                    ${type}
                    <span style="float:right;color:#8b949e;">${items.length}</span>
                </div>
            `
            )
            .join("") || '<div class="loading">æ— æ¨¡å¼</div>';

        // æ˜¾ç¤ºåˆ†æé¢æ¿
        if (files.length > 0) {
          showAnalysisSummary();
        }
      }

      function selectFile(name) {
        currentFile = files.find((f) => f.name === name);
        if (currentFile) {
          document
            .querySelectorAll(".sidebar-item")
            .forEach((el) => el.classList.remove("active"));
          event.target.closest(".sidebar-item").classList.add("active");

          const highlighted = highlightCode(currentFile.content);
          document.getElementById("codeContent").innerHTML = highlighted;
        }
      }

      function goToDefinition(fileName, position) {
        const file = files.find((f) => f.name === fileName);
        if (file) {
          currentFile = file;
          const highlighted = highlightCode(file.content);
          document.getElementById("codeContent").innerHTML = highlighted;

          // æ»šåŠ¨åˆ°ä½ç½®
          setTimeout(() => {
            const codeView = document.getElementById("codeView");
            const lineHeight = 20;
            const lineNumber = file.content
              .substring(0, position)
              .split("\n").length;
            codeView.scrollTop = (lineNumber - 5) * lineHeight;
          }, 100);
        }
      }

      function highlightCode(code) {
        // ç®€å•çš„è¯­æ³•é«˜äº®
        return code
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/(\/\/.*$)/gm, '<span class="comment">$1</span>')
          .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="comment">$1</span>')
          .replace(
            /\b(function|class|extends|return|if|else|for|while|switch|case|break|continue|new|this|const|let|var|async|await|import|export|from|default|try|catch|throw)\b/g,
            '<span class="keyword">$1</span>'
          )
          .replace(
            /(['"`])(?:(?!\1)[^\\]|\\.)*?\1/g,
            '<span class="string">$&</span>'
          )
          .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="number">$1</span>');
      }

      function searchCode() {
        const query = document.getElementById("searchInput").value;
        if (!query || !currentFile) return;

        try {
          const regex = new RegExp(query, "gi");
          const highlighted = currentFile.content
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(
              regex,
              '<mark style="background:#f0883e;color:#000;">$&</mark>'
            );
          document.getElementById("codeContent").innerHTML = highlighted;
        } catch (e) {
          alert("æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼");
        }
      }

      function beautifyCode() {
        if (!currentFile) return;

        try {
          // ç®€å•çš„ä»£ç ç¾åŒ–
          let code = currentFile.content;

          // æ·»åŠ æ¢è¡Œ
          code = code.replace(/;(?!\s*[\n\r])/g, ";\n");
          code = code.replace(/\{(?!\s*[\n\r])/g, "{\n");
          code = code.replace(/\}(?!\s*[\n\r])/g, "}\n");

          // æ·»åŠ ç¼©è¿›
          let indent = 0;
          code = code
            .split("\n")
            .map((line) => {
              line = line.trim();
              if (line.startsWith("}")) indent = Math.max(0, indent - 1);
              const result = "  ".repeat(indent) + line;
              if (line.endsWith("{")) indent++;
              return result;
            })
            .join("\n");

          currentFile.content = code;
          document.getElementById("codeContent").innerHTML =
            highlightCode(code);
        } catch (e) {
          alert("ç¾åŒ–å¤±è´¥: " + e.message);
        }
      }

      function showPatternDetails(type) {
        const items = patterns.filter((p) => p.type === type);
        const panel = document.getElementById("analysisPanel");
        panel.style.display = "block";

        document.getElementById("analysisContent").innerHTML = `
                <div class="analysis-item">
                    <h4>${type} (${items.length} å¤„)</h4>
                    <code>${items
                      .slice(0, 20)
                      .map((p) => `${p.file}: ${p.match}`)
                      .join("\n")}</code>
                </div>
            `;
      }

      function showAnalysisSummary() {
        const panel = document.getElementById("analysisPanel");
        panel.style.display = "block";

        // åˆ†æç»„ä»¶ç³»ç»Ÿ
        const componentClasses = classes.filter(
          (c) =>
            c.name.includes("Component") ||
            c.name.includes("Controller") ||
            c.name.includes("Manager") ||
            c.name.includes("System")
        );

        // åˆ†æç»§æ‰¿å…³ç³»
        const inheritance = classes.filter((c) => c.extends).slice(0, 10);

        // åˆ†æåŠ è½½é¡ºåº
        const loadOrder = files.map((f) => f.name);

        document.getElementById("analysisContent").innerHTML = `
                <div class="analysis-item">
                    <h4>ğŸ“¦ åŠ è½½é¡ºåº</h4>
                    <code>${loadOrder.join("\nâ†“\n")}</code>
                </div>
                <div class="analysis-item">
                    <h4>ğŸ§© å¯èƒ½çš„ç»„ä»¶ç±» (${componentClasses.length})</h4>
                    <code>${componentClasses
                      .map(
                        (c) =>
                          c.name + (c.extends ? " extends " + c.extends : "")
                      )
                      .join("\n")}</code>
                </div>
                <div class="analysis-item">
                    <h4>ğŸ”— ç»§æ‰¿å…³ç³»</h4>
                    <code>${inheritance
                      .map((c) => `${c.name} extends ${c.extends}`)
                      .join("\n")}</code>
                </div>
                <div class="analysis-item">
                    <h4>ğŸ“Š ç»Ÿè®¡</h4>
                    <code>æ–‡ä»¶æ•°: ${files.length}
æ€»å¤§å°: ${(files.reduce((a, f) => a + f.size, 0) / 1024).toFixed(1)} KB
ç±»å®šä¹‰: ${classes.length}
å‡½æ•°: ${functions.length}
æ¨¡å¼åŒ¹é…: ${patterns.length}</code>
                </div>
            `;
      }

      function exportAnalysis() {
        const analysis = {
          exportTime: new Date().toISOString(),
          files: files.map((f) => ({ name: f.name, size: f.size, url: f.url })),
          classes: classes,
          functions: functions.slice(0, 200),
          patterns: patterns,
          summary: {
            totalFiles: files.length,
            totalSize: files.reduce((a, f) => a + f.size, 0),
            totalClasses: classes.length,
            totalFunctions: functions.length,
            totalPatterns: patterns.length,
          },
        };

        const blob = new Blob([JSON.stringify(analysis, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fastspin_code_analysis.json";
        a.click();
      }

      // å¿«æ·é”®
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "f") {
          e.preventDefault();
          document.getElementById("searchInput").focus();
        }
      });
    </script>
  </body>
</html>
